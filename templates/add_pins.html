{% extends 'base.html' %}
{% block head %}
    <title>User Map</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      .controls {
        margin-top: 10px;
        border: 1px solid transparent;
        border-radius: 2px 0 0 2px;
        box-sizing: border-box;
        -moz-box-sizing: border-box;
        height: 32px;
        outline: none;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      }

      #pac-input {
        background-color: #fff;
        font-family: Roboto;
        font-size: 15px;
        font-weight: 300;
        margin-left: 12px;
        padding: 0 11px 0 13px;
        text-overflow: ellipsis;
        width: 300px;
      }

      #pac-input:focus {
        border-color: #4d90fe;
      }

      .pac-container {
        font-family: Roboto;
      }

      #type-selector {
        color: #fff;
        background-color: #4d90fe;
        padding: 5px 11px 0px 11px;
      }

      #type-selector label {
        font-family: Roboto;
        font-size: 13px;
        font-weight: 300;
      }
    </style>
{% endblock %}

{% block content %}
<!--Graphics and images here, maybe a flying JS suitcase a la ninja from MCF-->
<div>
  <h1>Search for a city</h1>

  <input id="pac-input" class="controls" type="text"
  placeholder="Enter a location">

  <form id="add-pin-form" action="/add_pins" method="POST">
    <div id="type-selector" class="controls">

      <input type="radio" name="pin_type" id="changetype-1"
      checked="checked" value="1" required="required">
      <label for="changetype-1">Add to wish list!</label>

      <input type="radio" name="pin_type" id="changetype-2" value="2">
      <label for="changetype-2">I want to go back here!</label>

      <input type="radio" name="pin_type" id="changetype-3" value="3">
      <label for="changetype-3">I do not want to go back here.</label>

    </div>

    <div id="submit">
        <input type="submit" name="Add Pin!">
    </div>
    
    </form>
</div>

<div id="map"></div>

<script
  src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&libraries=places&callback=initMap"
  async defer>
</script>

<script>
"use strict";

  var geocoder;
  var map;
  // var places;
  // var markers = [];

  function initMap() {

    var map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 0, lng: 0},
          zoom: 2
        });
        var input = /** @type {!HTMLInputElement} */(
            document.getElementById('pac-input'));
  }
 


  $('#add-pin-form').submit(function(evt){
    evt.preventDefault();

    var city = $("#city").val();
    var state = $("#state").val();
    var country = $("#country").val();
    var pinType = $("input[name=pin_type]:checked").val();
    console.log("pin type is: " + pinType);
    console.log("user entered: " + city + ", " + state + ", " + country);

    var address = city + ", " + state + ", " + country;
    console.log("address is: " + address)

    var url = "https://maps.googleapis.com/maps/api/geocode/json?address=";
    url = url + city + "+" + state + "+" + country + "&key={{ api_key }}"
    console.log("url is: " + url)

    geocoder.geocode( {'address': address}, function(results, status) {
      if (status === google.maps.GeocoderStatus.OK) {
        console.log("geocoding results: " + results);

        map.setCenter(results[0].geometry.location);
        
        var marker = new google.maps.Marker({
          map: map,
          position: results[0].geometry.location
        });

        $.get(url, function(data) {
          
          var lat = data.results[0].geometry.location.lat;
          var lng = data.results[0].geometry.location.lng;

          console.log(data.results[0].geometry.location.lat);
          console.log(data.results[0].geometry.location.lng);

          var formInputs = {
              "city": city,
              "state": state,
              "country": country,
              "lat": lat,
              "lng": lng,
              "pinType": pinType 
          };

          $.post("/add_pins",
                 formInputs, function(results) {
                  console.log(results)
                 });
        });
      } else {
        alert("Geocode was not successful for the following reason: " + status);
      }
    });

    return false;
  }); 

$.get('/user_pin_info.json', function (pins) {
  var pin, marker, html;

  for (var key in pins) {
    pin =  pins[key];

    marker = new google.maps.Marker({
      position: new google.maps.LatLng(pin.latitude, pin.longitude),
      map: map
    });
  }
})


</script>




{% endblock %}

